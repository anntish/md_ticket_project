version: 2

models:
  - name: dm_fact_ticket_offers
    description: >
      Все полученные данные о самых дешевых билетах

    config:
      elementary:
        timestamp_column: created_at
    tests:
      - elementary.volume_anomalies:
          time_bucket:
            period: hour
            count: 12
          detection_period:
            period: day
            count: 14
          detection_delay:
            period: hour
            count: 12
          config:
            severity: warn
            tags: ["dqc"]

      - elementary.freshness_anomalies:
          time_bucket:
            period: hour
            count: 12
          detection_period:
            period: day
            count: 7
          detection_delay:
            period: hour
            count: 12
          config:
            severity: warn
            tags: ["dqc"]

      - elementary.event_freshness_anomalies:
          event_timestamp_column: created_at
          update_timestamp_column: processed_src_dttm
          time_bucket:
            period: hour
            count: 12
          detection_delay:
            period: hour
            count: 12
          config:
            severity: warn
            tags: ["dqc"]

      - elementary.dimension_anomalies:
          dimensions:
            - status_code
            - endpoint
            - currency
            - price_bucket
            - transfers_cnt
            - is_direct
          time_bucket:
            period: hour
            count: 12
          detection_period:
            period: day
            count: 14
          detection_delay:
            period: hour
            count: 12
          config:
            severity: warn
            tags: ["dqc"]

    columns:
      - name: price_rub
        tests:
          - not_null:
              config:
                severity: error
          - dbt_utils.accepted_range:
              min_value: 0
              config:
                severity: error
          - elementary.column_anomalies:
              time_bucket:
                period: hour
                count: 12
              detection_period:
                period: day
                count: 14
              detection_delay:
                period: hour
                count: 12
              config:
                severity: warn
                tags: ["dqc"]
        tags: ["dqc"]

  - name: dm_prices_latest
    description: >
      Последняя найденная самая дешевая цена для каждой комбинации по дню управления и маршруту
    config:
      elementary:
        timestamp_column: created_at
    tests:
      - elementary.all_columns_anomalies:
          time_bucket:
            period: day
            count: 1
          detection_period:
            period: day
            count: 14
          config:
            severity: warn
            tags: ["dqc"]
    columns:
      - name: price_rub
        tests:
          - not_null:
              config:
                severity: error
      - name: aviasales_id
        tests:
          - relationships:
              to: ref('dm_fact_ticket_offers')
              field: aviasales_id

  - name: dm_prices_agg_search_dep_route
    description: >
      Средняя минимальная цена для каждой комбинации дня поиска, дня вылета и маршрута
    config:
      elementary:
        timestamp_column: search_date
    tests:
      - elementary.volume_anomalies:
          time_bucket:
            period: day
            count: 1
          detection_period:
            period: day
            count: 7
          config:
            severity: warn
            tags: ["dqc"]

  - name: dm_prices_agg_dep_route
    description: >
      Средняя минимальная цена для каждой комбинации дня вылета и маршрута
    config:
      elementary:
        timestamp_column: departure_date
    columns:
      - name: avg_price_rub
        tests:
          - elementary.column_anomalies:
              time_bucket:
                period: day
                count: 1
              detection_period:
                period: day
                count: 7
              config:
                severity: warn
                tags: ["dqc"]

  - name: dm_prices_agg_route
    description: >
      Средняя самая дешевая цена для каждого маршрута
    columns:
      - name: avg_price_rub
        tests:
          - not_null:
              config:
                severity: warn
                tags: ["dqc"]

  - name: dm_airports
    description: >
      Соответствие аэропортов и городов (коды)
    columns:
      - name: airport_code
        tests:
          - not_null:
              config:
                severity: error
              tags: ["dqc"]
